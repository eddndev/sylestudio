name: Deploy to Hostgator (Production)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Build Assets
        run: |
          npm ci
          npm run build

      - name: Upload Built Assets to Hostgator
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          source: "public/build"
          target: ${{ secrets.PROJECT_PATH }}

      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            set -e
            
            # --- CONFIGURACIÃ“N DE RUTAS ---
            # Tu PHP 8.3 real
            PHP_BIN="/opt/cpanel/ea-php83/root/usr/bin/php"
            # La ruta de Composer que encontraste
            COMPOSER_BIN="/opt/cpanel/composer/bin/composer"

            echo "ðŸš€ Iniciando despliegue usando PHP 8.3 y Composer de sistema..."
            
            cd ${{ secrets.PROJECT_PATH }}

            # 1. Poner en mantenimiento
            $PHP_BIN artisan down || true

            # 2. Descargar cÃ³digo (Git Pull)
            git pull origin main

            # 3. Instalar dependencias
            # Usamos $PHP_BIN delante de $COMPOSER_BIN para asegurar que Composer
            # se ejecute con la versiÃ³n 8.3 y no con la del sistema por defecto.
            export COMPOSER_ALLOW_SUPERUSER=1
            $PHP_BIN $COMPOSER_BIN install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            # 4. Migraciones y Limpieza
            $PHP_BIN artisan migrate --force
            
            echo "ðŸ§¹ Limpiando cachÃ©s..."
            $PHP_BIN artisan optimize:clear
            $PHP_BIN artisan config:cache
            $PHP_BIN artisan event:cache
            $PHP_BIN artisan route:cache
            $PHP_BIN artisan view:cache

            # 5. Levantar el sitio
            $PHP_BIN artisan up
            
            echo "âœ… Â¡Despliegue Exitoso!"